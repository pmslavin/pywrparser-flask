<!--
// vim: ft=javascript:
-->
<!DOCTYPE html>
<html>
<head></head>
<body>
  <style>
    #filename {
      display: inline-block;
    }
    input[type=file] {
      padding: 8px;
      width: 8px;
      opacity: 0;
    }
    label {
      background-color: #7F9CCB;
      padding: 5px 10px;
      border-radius: 5px;
      border: 1px ridge black;
      height: auto;
      margin: 2px 0;
      display: inline-block;
    }
    body {
      font-size: 0.8rem;
    }
  </style>
  <div class="file-container">
    <label for="file-input">Select file:</label>
    <span id="filename">No file selected</span>
    <input type="file" id="file-input">
  </div>
  <div id="status-container">
    <div class="status-line" id="progress-container">
    </div>
  </div>
</body>
<script type="module">
import {ProgressCircle} from "{{ url_for('pywr_upload.static', filename='js/ProgressCircle.js') }}";
const parserEP = "http://127.0.0.1:5000/parse";
//const parserEP = "https://httpbin.org/post";
const finp = document.getElementById("file-input");
const fname = document.getElementById("filename");
const activeProgress = [];

finp.addEventListener("change", loadFile);

function loadFile(e){
    const reader = new FileReader();
    reader.addEventListener("load", processFile);
    const fp = finp.files[0];
    fname.innerText = fp.name;
    console.log(fp);
    reader.readAsText(fp);
}

function processFile(e){
    try{
        const input = JSON.parse(e.target.result);
        console.log("input", input);
        parserPost(input);
    }catch(e){
        console.error(e);
    }
}

function parserPost(input){
    const progress = addStatusLine("status-container", "Validating Pywr file...")
    const xhr = new XMLHttpRequest();
    xhr.addEventListener("load", function(){
        console.log(xhr.status);
        console.log(xhr.response);
        const progress = addStatusLine("status-container", "Doing thing...")
    });
    xhr.upload.addEventListener("progress", function(e){
        const percent = e.loaded/e.total*100.0;
        console.log(`Progress: ${percent.toFixed(2)}`);
        progress.setPercent(percent);
    });
    xhr.open("POST", parserEP);
    xhr.setRequestHeader("Content-Type", "application/json");

    let payload = {
        compression: null,
        data: input
    };

    xhr.send(JSON.stringify(payload));
}

function addStatusLine(container, text){
    if(typeof container === "string")
        container = document.getElementById(container)

    if(!(container instanceof HTMLElement))
        return;

    const lineDiv = document.createElement("div");
    const lineCount = container.querySelectorAll("div.status-line").length;
    lineDiv.classList.add("status-line");
    lineDiv.setAttribute("id", `status-line-${lineCount+1}`);
    const progSpan = document.createElement("span");
    progSpan.style.display = "inline-block";
    progSpan.style.verticalAlign = "middle";
    const progress = new ProgressCircle(progSpan);
    const textSpan = document.createElement("span");
    textSpan.innerText = text;
    textSpan.style.padding = "8px";

    lineDiv.append(progSpan);
    lineDiv.append(textSpan);
    container.append(lineDiv);

    return progress;
}
</script>
</html>
